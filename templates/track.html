{% extends "layout.html" %}

{% block title %}{{ track.title }} - {{ album.title }}{% endblock %}

{% block content %}
<section class="track-detail">
    <!-- è¿”å›ä¸“è¾‘æŒ‰é’® -->
    <div class="back-to-album">
        <a href="/album/{{ album.id }}" class="btn-back">â† è¿”å›ä¸“è¾‘</a>
    </div>

    <!-- å•æ›²ä¸»è¦ä¿¡æ¯åŒº -->
    <div class="track-header">
        <!-- ä¸“è¾‘å°é¢ -->
        <div class="track-cover">
            <img src="{{ album.cover_image }}" alt="{{ album.title }}" loading="lazy">
        </div>

        <!-- å•æ›²ä¿¡æ¯ -->
        <div class="track-info">
            <p class="track-album-name">{{ album.title }}</p>
            <h1 class="track-title-main">{{ track.title }}</h1>
            <p class="track-meta">
                <span class="track-number">Track {{ '%02d' % track.track_number }}</span>
                <span class="track-duration">{{ track.duration }}</span>
            </p>
        </div>
    </div>

    <!-- éŸ³é¢‘æ’­æ”¾å™¨åŒºåŸŸï¼ˆæ”¯æŒè½®æ’­ï¼‰ -->
    <div class="track-player">
        {% if track.audio_url %}
            {% set audio_urls = track.audio_url %}
            {% if audio_urls is string %}
                {# å•ä¸ªæ’­æ”¾å™¨ï¼ˆæ—§æ ¼å¼å…¼å®¹ï¼‰ #}
                {% set audio_list = [audio_urls] %}
            {% elif audio_urls is iterable and audio_urls is not mapping %}
                {# æ•°ç»„æ ¼å¼ #}
                {% set audio_list = audio_urls %}
            {% else %}
                {% set audio_list = [] %}
            {% endif %}
            
            {% if audio_list|length > 0 %}
                <div class="player-carousel">
                    <!-- æ’­æ”¾å™¨å®¹å™¨ -->
                    <div class="carousel-container">
                        <div class="carousel-track">
                            {% for url in audio_list %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                {% if 'music.163.com' in url %}
                                    <!-- ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨ -->
                                    <div class="player-wrapper netease-player">
                                        <iframe src="{{ url }}"
                                                width="330" 
                                                height="86"
                                                style="border: none;"
                                                loading="lazy">
                                        </iframe>
                                    </div>
                                
                                {% elif 'youtube.com' in url or 'youtube-nocookie.com' in url %}
                                    <!-- YouTube æ’­æ”¾å™¨ -->
                                    <div class="player-wrapper youtube-player">
                                        <iframe src="{{ url }}" 
                                                width="680" 
                                                height="400"
                                                title="YouTube video player"
                                                frameborder="0"
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                                allowfullscreen>
                                        </iframe>
                                    </div>
                                
                                {% elif 'bilibili.com' in url %}
                                    <!-- Bilibili æ’­æ”¾å™¨ -->
                                    <div class="player-wrapper bilibili-player">
                                        <iframe src="{{ url }}"
                                                width="680"
                                                height="400"
                                                frameborder="0"
                                                scrolling="no"
                                                allowfullscreen="true">
                                        </iframe>
                                    </div>
                                
                                {% else %}
                                    <!-- é€šç”¨æ’­æ”¾å™¨ -->
                                    <div class="player-wrapper generic-player">
                                        <iframe src="{{ url }}" 
                                                width="100%" 
                                                height="200"
                                                style="border: none;"
                                                allowfullscreen
                                                loading="lazy">
                                        </iframe>
                                    </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- å·¦å³åˆ‡æ¢æŒ‰é’® -->
                        {% if audio_list|length > 1 %}
                        <button class="carousel-btn prev" aria-label="ä¸Šä¸€ä¸ªæ’­æ”¾å™¨">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <button class="carousel-btn next" aria-label="ä¸‹ä¸€ä¸ªæ’­æ”¾å™¨">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- è½®æ’­æŒ‡ç¤ºå™¨ï¼ˆç§»åˆ°åº•éƒ¨ï¼‰ -->
                    {% if audio_list|length > 1 %}
                    <div class="carousel-indicators">
                        {% for url in audio_list %}
                        <span class="indicator {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}" title="æ’­æ”¾å™¨ {{ loop.index }}"></span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            {% else %}
                <!-- audio_url æ˜¯ç©ºæ•°ç»„ -->
                <div class="no-audio">
                    <p>âš ï¸ è¯¥æ›²ç›®æš‚æ— éŸ³é¢‘é“¾æ¥</p>
                    <p class="help-text">
                        è¯·ä½¿ç”¨ update_track_meta.py æ·»åŠ æ’­æ”¾å™¨é“¾æ¥<br>
                        æ”¯æŒå¹³å°ï¼šç½‘æ˜“äº‘éŸ³ä¹ã€YouTubeã€Bilibili
                    </p>
                </div>
            {% endif %}
            
        {% else %}
            <!-- æ— éŸ³é¢‘é“¾æ¥æ—¶çš„æç¤º -->
            <div class="no-audio">
                <p>âš ï¸ è¯¥æ›²ç›®æš‚æ— éŸ³é¢‘é“¾æ¥</p>
                <p class="help-text">
                    è¯·ä½¿ç”¨ update_track_meta.py æ·»åŠ æ’­æ”¾å™¨é“¾æ¥<br>
                    æ”¯æŒå¹³å°ï¼šç½‘æ˜“äº‘éŸ³ä¹ã€YouTubeã€Bilibili
                </p>
            </div>
        {% endif %}
    </div>

    <!-- æè¿°åŒºåŸŸï¼ˆåŸ"æ­Œè¯"åŒºåŸŸï¼Œå¤ç”¨ tracks.lyrics å­—æ®µä½œä¸ºæè¿°å­˜å‚¨ï¼‰ -->
    <div class="track-lyrics">
        
        {% if track.lyrics %}
            <!-- æ˜¾ç¤ºæè¿°ï¼ˆæ¯è¡Œç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼‰ -->
            <div class="lyrics-content">
                {% for line in track.lyrics.split('\n') %}
                    <p class="lyrics-line">{{ line }}</p>
                {% endfor %}
            </div>
        {% else %}
            <!-- æ— æè¿°æ—¶çš„æç¤º -->
            <div class="no-lyrics">
                <p>ğŸ“ è¯¥æ›²ç›®æš‚æ— æè¿°</p>
                <p class="help-text">
                    å¦‚ä½•æ·»åŠ æè¿°åˆ°æ•°æ®åº“ï¼š<br><br>
                    1. å‡†å¤‡æè¿°æ–‡æœ¬ï¼ˆå¯å¤šè¡Œï¼Œç”¨ \n åˆ†éš”ï¼‰<br>
                    2. æ‰§è¡Œ SQL æ›´æ–°ï¼š<br>
                    <code>
                        UPDATE tracks SET lyrics = 'ç¬¬ä¸€è¡Œæè¿°\nç¬¬äºŒè¡Œæè¿°\nç¬¬ä¸‰è¡Œæè¿°...' WHERE id = {{ track.id }};
                    </code><br><br>
                    å»ºè®®ä¸è¦ç²˜è´´å—ç‰ˆæƒä¿æŠ¤çš„å®Œæ•´æ­Œè¯ï¼Œå¯ä¹¦å†™ä¸ªäººæ„Ÿå—ã€ç®€ä»‹æ‘˜è¦ï¼Œæˆ–æ·»åŠ å®˜æ–¹é¡µé¢é“¾æ¥ã€‚
                </p>
            </div>
        {% endif %}
    </div>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button id="back-to-top" class="back-to-top" aria-label="è¿”å›é¡¶éƒ¨">
        <img src="https://zutomayo.net/themes/zutomayo/_assets/img/btn_pagetop.png" alt="è¿”å›é¡¶éƒ¨">
    </button>

</section>
{% endblock %}
